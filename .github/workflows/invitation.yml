name: Invite on Label

on:
  issues:
    types: [labeled]

jobs:
  automate_invite:
    runs-on: ubuntu-latest
    permissions:
      issues: write
  
    steps:
      - name: Issue Checker
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.INVITE_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue = context.payload.issue;
            const author = issue.user.login;

            const { data } = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue is:open author:${author}`
            });

            const otherIssues = data.items.filter(i => i.number !== issue.number);

            if (otherIssues.length > 0) {
              const message =
                "⚠️ **Duplicate Join Request Detected**\n\n" +
                "You already have an open join request:\n" +
                `- #${otherIssues[0].number}\n\n` +
                "Please wait for it to be processed before creating another issue.";

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body: message
              });

              await github.rest.issues.update({
                owner,
                repo,
                issue_number: issue.number,
                state: "closed"
              });

              await github.rest.issues.lock({
                owner,
                repo,
                issue_number: issue.number,
                lock_reason: "spam"
              });
            }
            
      - name: Join Request
        uses: vj-abigo/invite-on-label@v1.2
        with:
          organization: itparadigmdll
          label: Join Request
          repo-token: ${{ secrets.GITHUB_TOKEN }}          
          comment: |
            ### Invitation from DLL IT Paradigm
            > Thank you for joining us! Please help keep this community healthy by sharing, caring, and inspiring one another.
            >
            > This is an automated invitation. Please **[ACCEPT the invitation](https://github.com/orgs/itparadigmdll/invitation)**.
            >
            > **After accepting, comment `DONE` on this issue so we can add you to your team.**
            
            — From the organization's administrators

        env:
          INVITE_TOKEN: ${{ secrets.INVITE_TOKEN }}
     
